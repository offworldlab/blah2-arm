version: '3'

networks:
    blah2:
      external: true

services:

  blah2:
    restart: always
    build: .
    image: blah2
    tty: true
    depends_on: 
      - blah2_api
    volumes:
      - /opt/blah2/config:/opt/blah2/config  # Shared config directory (user.yml + debug copies)
      - /opt/blah2/save:/opt/blah2/save
      - /dev/shm:/dev/shm:rw
      - /dev/bus/usb:/dev/bus/usb:rw     
      - /usr/local/lib/libsdrplay_api.so.3.15:/usr/local/lib/libsdrplay_api.so.3
      - /opt/blah2/test:/opt/blah2/test
      - /opt/blah2/sdrplay-restart.sh:/opt/blah2/sdrplay-restart.sh
   
    network_mode: host
    privileged: true
    # Command: restart SDR -> merge configs (default.yml + user.yml + forced.yml) -> start app
    # Config merge: reads /opt/blah2/config/user.yml, writes internal /opt/blah2/config.yml + debug copy out
    command: bash -c "/opt/blah2/sdrplay-restart.sh && python3 /opt/blah2/script/merge_config.py /opt/blah2/defaults /opt/blah2/config/user.yml /opt/blah2/config.yml /opt/blah2/config/config.blah2.debug.yml && /opt/blah2/bin/blah2 -c /opt/blah2/config.yml"   
    container_name: blah2

  blah2_web:
    restart: always
    image: httpd:2.4
    ports: 
      - 49152:80
    volumes:
      - ./web/html:/usr/local/apache2/htdocs
    networks:
      - blah2
    container_name: blah2-web

  blah2_api:
    restart: always
    build: ./api
    image: blah2_api
    volumes:
      - ./config:/usr/src/app/config  # Shared config directory (user.yml + debug copies)
      - ./api/server.js:/usr/src/app/server.js
    network_mode: host
    # Command: merge configs (default.yml + user.yml + forced.yml) -> start API server
    # Config merge: reads /usr/src/app/config/user.yml, writes internal /usr/src/app/config.yml + debug copy out
    command: bash -c "python3 /usr/src/app/script/merge_config.py /usr/src/app/defaults /usr/src/app/config/user.yml /usr/src/app/config.yml /usr/src/app/config/config.api.debug.yml && node server.js /usr/src/app/config.yml"
    container_name: blah2-api

  blah2_host:
    restart: always
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./host/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./host/html:/usr/local/apache2/htdocs:ro
    networks:
      - blah2
    container_name: blah2-host
    depends_on:
      - blah2_web
      - blah2_api